{% extends "account/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<link rel="stylesheet" href="{% static 'company/zone_form.css' %}">

{% if is_popup %}
<a href="javascript:window.close();" class="back-button">
{% else %}
<a href="{% url 'company:zone_list' %}" class="back-button">
{% endif %}
    <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
        <path
            d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.22707 874.690416 495.52477z">
        </path>
    </svg>
    <span>Retour</span>
</a>

<h2 class="form_title">
    {% if is_new %}
    Créer une nouvelle zone de diffusion
    {% else %}
    Modifier la zone de diffusion
    {% endif %}
</h2>

<hr class="head-hr">

<div class="form-container">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.errors %}
        <div class="form-errors">
            {% for field in form %}
                {% for error in field.errors %}
                    <div class="error-message">{{ error }}</div>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <div class="error-message">{{ error }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="search-container">
            <label for="address-search">Rechercher une adresse</label>
            <div class="autocomplete-container">
                <input type="text" id="address-search" class="search-input" placeholder="Entrez une adresse, une ville ou un code postal">
                <div id="autocomplete-results" class="autocomplete-results"></div>
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.name.id_for_label }}">Nom de la ville</label>
            {{ form.name }}
        </div>

        <div class="form-group">
            <label for="{{ form.latitude.id_for_label }}">Latitude</label>
            {{ form.latitude }}
            <small class="form-text text-muted">Exemple: 48.8566 (Paris)</small>
        </div>

        <div class="form-group">
            <label for="{{ form.longitude.id_for_label }}">Longitude</label>
            {{ form.longitude }}
            <small class="form-text text-muted">Exemple: 2.3522 (Paris)</small>
        </div>

        <div class="map-container">
            <div id="map" style="height: 300px; width: 100%; margin-bottom: 20px;"></div>
            <button type="button" id="get-location" class="btn btn-secondary">Utiliser ma position actuelle</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-btn">
                {% if is_new %}
                Créer la zone
                {% else %}
                Enregistrer les modifications
                {% endif %}
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la carte
        var map = L.map('map').setView([48.8566, 2.3522], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var marker = L.marker([48.8566, 2.3522], {
            draggable: true
        }).addTo(map);

        // Mettre à jour les champs de latitude et longitude lorsque le marqueur est déplacé
        marker.on('dragend', function(event) {
            var position = marker.getLatLng();
            document.getElementById('id_latitude').value = position.lat.toFixed(6);
            document.getElementById('id_longitude').value = position.lng.toFixed(6);
        });

        // Mettre à jour le marqueur lorsque les champs de latitude et longitude sont modifiés
        document.getElementById('id_latitude').addEventListener('change', updateMarker);
        document.getElementById('id_longitude').addEventListener('change', updateMarker);

        function updateMarker() {
            var lat = parseFloat(document.getElementById('id_latitude').value);
            var lng = parseFloat(document.getElementById('id_longitude').value);

            if (!isNaN(lat) && !isNaN(lng)) {
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 13);
            }
        }

        // Initialiser le marqueur avec les valeurs des champs
        updateMarker();

        // Utiliser la géolocalisation du navigateur
        document.getElementById('get-location').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    document.getElementById('id_latitude').value = lat.toFixed(6);
                    document.getElementById('id_longitude').value = lng.toFixed(6);

                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 13);
                }, function(error) {
                    alert('Erreur de géolocalisation: ' + error.message);
                });
            } else {
                alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
            }
        });

        // Autocomplétion d'adresse
        const searchInput = document.getElementById('address-search');
        const resultsContainer = document.getElementById('autocomplete-results');
        let debounceTimer;

        // Fonction pour effectuer la recherche d'adresse
        function searchAddress(query) {
            if (query.length < 3) {
                resultsContainer.style.display = 'none';
                return;
            }

            // Utiliser directement l'API adresse.data.gouv.fr qui est plus fiable
            fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.features && data.features.length > 0) {
                        const results = data.features.map(feature => ({
                            label: feature.properties.label,
                            coordinates: feature.geometry.coordinates,
                            city: feature.properties.city || feature.properties.name || feature.properties.postcode
                        }));
                        displayResults(results);
                    } else {
                        // Si aucun résultat, essayer avec l'API de géocodage de l'IGN
                        return fetch(`https://data.geopf.fr/geocodage/completion?text=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(ignData => {
                                if (ignData && ignData.results && ignData.results.length > 0) {
                                    const ignResults = ignData.results.map(result => {
                                        // Extraire la ville du texte complet
                                        let city = result.fulltext.split(',')[0].trim();

                                        return {
                                            label: result.fulltext,
                                            // Les coordonnées sont inversées dans l'API IGN par rapport à l'API adresse.data.gouv.fr
                                            coordinates: [result.position.x, result.position.y],
                                            city: city
                                        };
                                    });
                                    displayResults(ignResults);
                                } else {
                                    // Aucun résultat trouvé
                                    resultsContainer.innerHTML = '<div class="autocomplete-item">Aucun résultat trouvé</div>';
                                    resultsContainer.style.display = 'block';
                                }
                            });
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la recherche d\'adresse:', error);
                    // En cas d'erreur, essayer l'autre API
                    fetch(`https://data.geopf.fr/geocodage/completion?text=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.results && data.results.length > 0) {
                                const results = data.results.map(result => ({
                                    label: result.fulltext,
                                    coordinates: [result.position.x, result.position.y],
                                    city: result.fulltext.split(',')[0].trim()
                                }));
                                displayResults(results);
                            } else {
                                resultsContainer.innerHTML = '<div class="autocomplete-item">Aucun résultat trouvé</div>';
                                resultsContainer.style.display = 'block';
                            }
                        })
                        .catch(err => {
                            console.error('Erreur avec les deux APIs:', err);
                            resultsContainer.innerHTML = '<div class="autocomplete-item">Erreur lors de la recherche</div>';
                            resultsContainer.style.display = 'block';
                        });
                });
        }

        // Fonction pour afficher les résultats
        function displayResults(results) {
            resultsContainer.innerHTML = '';

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="autocomplete-item">Aucun résultat trouvé</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = result.label || result.fulltext;

                item.addEventListener('click', () => {
                    // Récupérer les coordonnées
                    let lng, lat, city;

                    if (result.coordinates) {
                        // Format API adresse.data.gouv.fr ou format normalisé
                        [lng, lat] = result.coordinates;
                        city = result.city;
                    } else if (result.position) {
                        // Format API IGN
                        lng = result.position.x;
                        lat = result.position.y;
                        city = result.city || result.fulltext.split(',')[0].trim();
                    }

                    if (lat && lng) {
                        // Mettre à jour les champs du formulaire
                        document.getElementById('id_name').value = city;
                        document.getElementById('id_latitude').value = lat;
                        document.getElementById('id_longitude').value = lng;

                        // Mettre à jour le marqueur et la carte
                        marker.setLatLng([lat, lng]);
                        map.setView([lat, lng], 13);

                        // Mettre à jour le champ de recherche et cacher les résultats
                        searchInput.value = result.label || result.fulltext;
                        resultsContainer.style.display = 'none';
                    } else {
                        console.error('Coordonnées invalides:', result);
                        alert('Impossible de récupérer les coordonnées pour cette adresse. Veuillez en choisir une autre.');
                    }
                });

                resultsContainer.appendChild(item);
            });

            resultsContainer.style.display = 'block';
        }

        // Événement de saisie dans le champ de recherche
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchAddress(this.value);
            }, 300);
        });

        // Cacher les résultats lorsqu'on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });
    });
</script>

{% endblock content %}
