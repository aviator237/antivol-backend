{% extends "account/base.html" %}
{% load static %}

{% block title %}<title>{{ catalog.title }}</title>{% endblock %}


{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<link rel="stylesheet" href="{% static 'company/catalog_detail.css' %}">

<a href="{% url 'company:catalog_list' %}" class="back-button">
    <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
        <path d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.22707 874.690416 495.52477z"></path>
    </svg>
    Retour
</a>

<h2 class="album_name">{{ catalog.title }}</h2>

<div class="catalog-info">
    <p>
        Publié le {{ catalog.created_at|date:"d/m/Y à H:i" }} par
        {{ catalog.publisher.get_full_name|default:catalog.publisher.username }}
    </p>
    {% if catalog.updated_at != catalog.created_at %}
    <p>
        Dernière mise à jour le {{ catalog.updated_at|date:"d/m/Y à H:i" }}
    </p>
    {% endif %}
</div>

<div class="btn-list">
    <a href="{% url 'company:catalog_download' catalog.id %}" class="action-btn btn-download">
        <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" fill="white"/>
        </svg>
        Télécharger
    </a>

    {% if is_owner %}
    <a href="{% url 'company:catalog_update' catalog.id %}" class="action-btn btn-edit">
        <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
        </svg>
        Modifier
    </a>

    <a href="{% url 'company:catalog_delete' catalog.id %}" class="action-btn btn-delete">
        <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z" fill="white"/>
        </svg>
        Supprimer
    </a>
    {% endif %}
</div>

<div class="distribution-zones-container">
    <div class="zones-header">
        <h3>Zones de diffusion</h3>
    </div>
    <div class="zones-body">
        {% if catalog.distribution_zones.all %}
            <div class="zones-list-map-container">
                <div class="zones-list">
                    <h4>Liste des zones</h4>
                    <ul>
                        {% for zone in catalog.distribution_zones.all %}
                            <li>
                                <span class="zone-name">{{ zone.name }}</span>
                                <a href="javascript:void(0);" class="zone-locate"
                                   data-lat="{{ zone.latitude }}" data-lng="{{ zone.longitude }}"
                                   data-name="{{ zone.name }}">
                                    <svg height="12" width="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                        <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                    </svg>
                                    Localiser
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="zones-map">
                    <div id="map" style="height: 300px;"></div>
                </div>
            </div>
        {% else %}
            <div class="no-zones">
                <p>Aucune zone de diffusion n'est définie pour ce catalogue.</p>
                {% if is_owner %}
                    <p>
                        <a href="{% url 'company:catalog_update' catalog.id %}" class="btn-add-zones">
                            Ajouter des zones de diffusion
                        </a>
                    </p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<div class="preview-container">
    <div class="preview-header">
        <h3>Aperçu du catalogue</h3>
    </div>
    <div class="preview-body">
        <iframe class="preview-iframe" src="{{ catalog.file.url }}"></iframe>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la carte si des zones existent
        {% if catalog.distribution_zones.all %}
            // Vérifier si l'élément de carte existe
            var mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error("Élément de carte introuvable");
                return;
            }

            // Créer la carte
            var map = L.map('map', {
                // Options par défaut
                minZoom: 2,
                maxZoom: 18
            });

            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Créer un groupe pour les marqueurs
            var markers = L.featureGroup();

            // Ajouter les marqueurs pour chaque zone
            {% for zone in catalog.distribution_zones.all %}
                try {
                    var lat = parseFloat("{{ zone.latitude|floatformat:6 }}".replace(',', '.'));
                    var lng = parseFloat("{{ zone.longitude|floatformat:6 }}".replace(',', '.'));

                    // Vérifier que les coordonnées sont valides
                    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        var marker = L.marker([lat, lng])
                            .bindPopup("<strong>{{ zone.name }}</strong>");
                        markers.addLayer(marker);
                    } else {
                        console.warn("Coordonnées invalides pour la zone {{ zone.name }}: [{{ zone.latitude }}, {{ zone.longitude }}]");
                    }
                } catch (e) {
                    console.error("Erreur lors de la création du marqueur pour {{ zone.name }}:", e);
                }
            {% endfor %}

            // Ajouter le groupe de marqueurs à la carte
            markers.addTo(map);

            // Ajuster la vue pour montrer tous les marqueurs
            try {
                // Vérifier si la méthode getLayers existe
                if (typeof markers.getLayers === 'function') {
                    var layers = markers.getLayers();

                    if (layers.length > 1) {
                        // S'il y a plusieurs marqueurs, ajuster les limites
                        map.fitBounds(markers.getBounds(), { padding: [30, 30] });
                    } else if (layers.length === 1) {
                        // S'il n'y a qu'un seul marqueur, centrer sur ce marqueur avec un zoom approprié
                        var marker = layers[0];
                        map.setView(marker.getLatLng(), 13);
                    } else {
                        // S'il n'y a pas de marqueurs, centrer sur la France
                        map.setView([46.603354, 1.888334], 6);
                    }
                } else {
                    // Si getLayers n'existe pas, essayer d'utiliser getBounds directement
                    try {
                        map.fitBounds(markers.getBounds(), { padding: [30, 30] });
                    } catch (e) {
                        // En cas d'erreur, centrer sur la France
                        map.setView([46.603354, 1.888334], 6);
                    }
                }
            } catch (e) {
                // En cas d'erreur, centrer sur la France
                console.error("Erreur lors de l'ajustement de la carte:", e);
                map.setView([46.603354, 1.888334], 6);
            }

            // Gérer les clics sur les boutons "Localiser"
            document.querySelectorAll('.zone-locate').forEach(function(button) {
                button.addEventListener('click', function() {
                    try {
                        var lat = parseFloat(this.getAttribute('data-lat'));
                        var lng = parseFloat(this.getAttribute('data-lng'));
                        var name = this.getAttribute('data-name');

                        if (!isNaN(lat) && !isNaN(lng)) {
                            // Centrer la carte sur la zone
                            map.setView([lat, lng], 13);

                            // Ouvrir le popup correspondant
                            if (typeof markers.eachLayer === 'function') {
                                markers.eachLayer(function(layer) {
                                    if (layer._latlng &&
                                        Math.abs(layer._latlng.lat - lat) < 0.0001 &&
                                        Math.abs(layer._latlng.lng - lng) < 0.0001) {
                                        layer.openPopup();
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.error("Erreur lors de la localisation:", e);
                    }
                });
            });
        {% endif %}
    });
</script>
{% endblock %}
