{% extends "account/base.html" %}
{% load static %}

{% block title %}<title>Informations de {{ company.name }}</title>{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<link rel="stylesheet" href="{% static 'company/company_detail.css' %}">

<a href="{% url 'company:dashboard' %}" class="back-button">
    <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
        <path d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.22707 874.690416 495.52477z"></path>
    </svg>
    Retour
</a>

<h2 class="album_name">Informations de l'entreprise</h2>

<div class="company-info-container">
    <div class="company-info-header">
        <h3>{{ company.name }}</h3>
        {% if is_owner %}
        <a href="{% url 'company:company_update' %}" class="edit-btn">
            <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z" fill="white"/>
            </svg>
            Modifier
        </a>
        {% endif %}
    </div>

    <div class="info-section">
        <h4>Informations générales</h4>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Catégorie</div>
                <div class="info-value">{{ company.category|default:"Non spécifiée" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Numéro SIRET</div>
                <div class="info-value">{{ company.siret }}</div>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h4>Adresse</h4>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Adresse</div>
                <div class="info-value">{{ company.address }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Code postal</div>
                <div class="info-value">{{ company.postal_code }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Ville</div>
                <div class="info-value">{{ company.city }}</div>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h4>Horaires d'ouverture</h4>
        <div class="hours-container">
            <div class="hours-item">
                <div class="info-label">Heure d'ouverture</div>
                <div class="info-value">{{ company.opening_hour|time:"H:i" }}</div>
            </div>
            <div class="hours-item">
                <div class="info-label">Heure de fermeture</div>
                <div class="info-value">{{ company.closing_hour|time:"H:i" }}</div>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h4>Localisation</h4>
        {% if company.latitude and company.longitude %}
            <div class="location-info">
                <div class="location-details">
                    <div class="info-item">
                        <div class="info-label">Adresse complète</div>
                        <div class="info-value">{{ company.address }}, {{ company.postal_code }} {{ company.city }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Coordonnées GPS</div>
                        <div class="info-value">{{ company.latitude|floatformat:6 }}, {{ company.longitude|floatformat:6 }}</div>
                    </div>
                    <div class="location-actions">
                        <a href="https://www.google.com/maps/search/?api=1&query={{ company.latitude }},{{ company.longitude }}"
                           class="directions-btn" target="_blank" rel="noopener noreferrer">
                            <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224 192 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l210.7 0-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l128-128zM160 96c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 32C43 32 0 75 0 128L0 384c0 53 43 96 96 96l64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l64 0z" fill="currentColor"/>
                            </svg>
                            Itinéraire Google Maps
                        </a>
                        <a href="https://www.openstreetmap.org/?mlat={{ company.latitude }}&mlon={{ company.longitude }}&zoom=16"
                           class="osm-btn" target="_blank" rel="noopener noreferrer">
                            <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z" fill="currentColor"/>
                            </svg>
                            Voir sur OpenStreetMap
                        </a>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    try {
                        // Initialiser la carte
                        var map = L.map('map', {
                            zoomControl: true,
                            scrollWheelZoom: false
                        }).setView([{{ company.latitude }}, {{ company.longitude }}], 15);

                        // Ajouter la couche de tuiles OpenStreetMap
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        // Créer une icône personnalisée pour le marqueur
                        var customIcon = L.icon({
                            iconUrl: '{% static "images/marker-icon.png" %}',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowUrl: '{% static "images/marker-shadow.png" %}',
                            shadowSize: [41, 41]
                        });

                        // Ajouter un marqueur avec l'icône personnalisée
                        var marker = L.marker([{{ company.latitude }}, {{ company.longitude }}], {
                            icon: customIcon
                        }).addTo(map);

                        // Ajouter un popup au marqueur
                        marker.bindPopup(`
                            <strong>{{ company.name }}</strong><br>
                            {{ company.address }}<br>
                            {{ company.postal_code }} {{ company.city }}
                        `).openPopup();

                        // Ajouter un cercle pour montrer la zone approximative
                        L.circle([{{ company.latitude }}, {{ company.longitude }}], {
                            color: 'rgba(var(--second-color2-rgb), 0.8)',
                            fillColor: 'rgba(var(--second-color2-rgb), 0.2)',
                            fillOpacity: 0.5,
                            radius: 250
                        }).addTo(map);

                        // Activer le zoom sur la carte au clic
                        map.on('click', function() {
                            if (!map.scrollWheelZoom.enabled()) {
                                map.scrollWheelZoom.enable();
                            }
                        });

                        // Désactiver le zoom au scroll lorsque la souris quitte la carte
                        map.on('mouseout', function() {
                            map.scrollWheelZoom.disable();
                        });
                    } catch (e) {
                        console.error("Erreur lors de l'initialisation de la carte:", e);
                        document.getElementById('map').innerHTML = '<div class="map-error">Erreur lors du chargement de la carte</div>';
                    }
                });
            </script>
        {% else %}
            <div class="location-missing">
                <svg height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                    <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z" fill="currentColor"/>
                </svg>
                <p>Aucune coordonnée géographique n'est disponible pour cette entreprise.</p>
                {% if is_owner %}
                    <a href="{% url 'company:company_update' %}" class="add-location-btn">
                        Ajouter la localisation
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
{% endblock %}
